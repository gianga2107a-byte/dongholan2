Python 3.14.0 (tags/v3.14.0:ebf955d, Oct  7 2025, 10:15:03) [MSC v.1944 64 bit (AMD64)] on win32
Enter "help" below or click "Help" above for more information.
>>> <!DOCTYPE html>
... <html lang="vi">
... <head>
...   <meta charset="utf-8" />
...   <title>Qu·∫£n l√Ω ‚Äî Gia ph·∫£ d√≤ng h·ªç Gi√†ng</title>
...   <meta name="viewport" content="width=device-width,initial-scale=1" />
...   <style>
...     :root{
...       --primary:#0066cc; --accent:#004c99; --muted:#6b7280;
...       --bg:#f6f9fc; --card:#fff;
...     }
...     *{box-sizing:border-box}
...     body{font-family:Inter, "Segoe UI", Roboto, Arial; margin:0; background:var(--bg); color:#111}
...     .wrap{max-width:1100px;margin:28px auto;padding:18px}
...     .card{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 6px 20px rgba(20,30,60,.06)}
...     h1{margin:0 0 12px;font-size:20px}
...     .grid{display:grid;grid-template-columns:1fr 420px;gap:16px}
...     @media (max-width:920px){.grid{grid-template-columns:1fr}}
...     label{display:block;font-size:13px;color:var(--muted);margin-top:8px}
...     input[type="text"], input[type="number"], select, textarea{
...       width:100%;padding:8px 10px;border-radius:8px;border:1px solid #e6eef9;background:#fbfdff;margin-top:6px;
...       font-size:14px;
...     }
...     textarea{min-height:72px;resize:vertical}
...     .row{display:flex;gap:8px;align-items:center;margin-top:10px}
...     button{background:var(--primary);color:white;border:0;padding:8px 10px;border-radius:8px;cursor:pointer}
...     button.ghost{background:#eef6ff;color:var(--primary);border:1px solid #cfe1fb}
...     button.warn{background:#ff5c5c}
...     .controls{display:flex;gap:8px;flex-wrap:wrap}
...     .list{margin-top:12px;max-height:520px;overflow:auto;padding-right:6px}
...     .member{padding:10px;border-bottom:1px solid #f0f4f8;display:flex;justify-content:space-between;gap:8px;align-items:flex-start}
    .meta{color:var(--muted);font-size:13px;margin-top:6px}
    .actions button{margin-left:6px;padding:6px 8px;font-size:13px;border-radius:8px}
    .actions button.ghost{background:#f3f6fb;color:#0366d6;border:1px solid #d7e9ff}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
    .small{font-size:13px;padding:6px 8px;border-radius:8px}
    .tree{margin-top:12px;border-top:1px dashed #eef2f7;padding-top:12px}
    .tree ul{padding-left:18px;margin:6px 0}
    .search{padding:8px;border-radius:8px;border:1px solid #e6eef9;background:#fff;flex:1}
    .note{color:var(--muted);font-size:13px;margin-top:6px}
    .error{color:#b00020;font-size:13px;margin-top:6px}
    .badge{background:#eef6ff;color:var(--primary);padding:4px 8px;border-radius:999px;font-size:12px}
    footer{margin-top:12px;color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>üìú Gia ph·∫£ d√≤ng h·ªç Gi√†ng</h1>
      <div class="grid">
        <!-- Left: Form + List -->
        <div>
          <h3 id="formTitle">Th√™m th√†nh vi√™n m·ªõi</h3>
          <div id="formError" class="error" style="display:none"></div>

          <input type="hidden" id="memberId">

          <label>H·ªç v√† t√™n *</label>
          <input id="hoTen" type="text" placeholder="V√≠ d·ª•: Nguy·ªÖn VƒÉn A" />

          <label>ƒê·ªùi th·ª© *</label>
          <input id="doiThu" type="number" min="1" placeholder="V√≠ d·ª•: 3" />

          <label>Cha (li√™n k·∫øt)</label>
          <select id="fatherSelect"><option value="">‚Äî Ch·ªçn cha (n·∫øu l√† th√†nh vi√™n kh√°c) ‚Äî</option></select>

          <label>M·∫π (li√™n k·∫øt)</label>
          <select id="motherSelect"><option value="">‚Äî Ch·ªçn m·∫π (n·∫øu l√† th√†nh vi√™n kh√°c) ‚Äî</option></select>

          <label>Ng√†y Th√°ng NƒÉm sinh</label>
          <input id="ngaysinh" type="number" placeholder="ng√†y sinh (v√≠ d·ª•:01)"/>
          <input id="th√°nginh" type="number" placeholder="th√°ng sinh (v√≠ d·ª•: 01)"/>
          <input id="namsinh" type="number" placeholder="nƒÉm sinh (v√≠ d·ª•:1945)" />

          <label>Ng√†y Th√°ng NƒÉm m·∫•t</label>
          <input id="ngaymat" type="number" placeholder="ng√†y m·∫•t (n·∫øu c√≥)"/>
          <input id="thangmat" type="nuber" placeholder="th√°ng m·∫•t (n·∫øu c√≥)"/>
          <input id="nammat" type="number" placeholder="nƒÉm m·∫•t (n·∫øu c√≥)" />

          <label>C√¥ng vi·ªác</label>
          <textarea id="congviec"placeholder="C√¥ng vi·ªác..."></textarea>
          <label>Ghi ch√∫</label>
          <textarea id="ghiChu" placeholder="Ghi ch√∫ th√™m..."></textarea>

          <div class="row">
            <button id="saveBtn">üíæ L∆∞u</button>
            <button id="resetBtn" class="ghost">L√†m m·ªõi</button>
            <button id="clearAllBtn" class="ghost" title="X√≥a to√†n b·ªô d·ªØ li·ªáu (kh√¥ng th·ªÉ ho√†n t√°c)">X√≥a to√†n b·ªô</button>
            <div style="margin-left:auto" id="statusBadge" class="badge" style="display:none"></div>
          </div>

          <hr />

          <div class="toolbar">
            <input id="searchInput" class="search" placeholder="T√¨m theo t√™n, nƒÉm, ho·∫∑c ghi ch√∫..." />
            <select id="filterGeneration" class="small">
              <option value="">T·∫•t c·∫£ ƒë·ªùi</option>
            </select>
            <select id="sortSelect" class="small">
              <option value="name">S·∫Øp x·∫øp: T√™n (A‚ÜíZ)</option>
              <option value="doi-asc">ƒê·ªùi (tƒÉng d·∫ßn)</option>
              <option value="doi-desc">ƒê·ªùi (gi·∫£m d·∫ßn)</option>
              <option value="born-asc">NƒÉm sinh (tƒÉng d·∫ßn)</option>
              <option value="born-desc">NƒÉm sinh (gi·∫£m d·∫ßn)</option>
            </select>
            <button id="exportBtn" class="small ghost">Xu·∫•t JSON</button>
            <label for="importFile" class="small ghost" style="cursor:pointer;margin:0">Nh·∫≠p JSON</label>
            <input id="importFile" type="file" accept="application/json" style="display:none" />
          </div>

          <div class="list" id="danhSach"></div>
        </div>

        <!-- Right: Tree / Preview -->
        <div>
          <h3>C√¢y quan h·ªá</h3>
          <div class="note">M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã to√†n b·ªô. Ch·ªçn m·ªôt th√†nh vi√™n trong danh s√°ch ƒë·ªÉ cƒÉn gi·ªØa trong c√¢y.</div>
          <div id="treeWrap" class="tree card" style="padding:12px;margin-top:8px;max-height:640px;overflow:auto"></div>

          <h3 style="margin-top:12px">H∆∞·ªõng d·∫´n ng·∫Øn</h3>
          <div class="note">
            - M·ªói th√†nh vi√™n c√≥ ID duy nh·∫•t; b·∫°n c√≥ th·ªÉ S·ª≠a, X√≥a.<br>
            - Cha/M·∫π c√≥ th·ªÉ li√™n k·∫øt t·ªõi th√†nh vi√™n kh√°c (dropdown). N·∫øu cha/m·∫π kh√¥ng c√≥ trong danh s√°ch, b·ªè tr·ªëng v√† ghi t√™n trong ghi ch√∫.<br>
            - D·ªØ li·ªáu l∆∞u trong localStorage; d√πng "Xu·∫•t JSON" ƒë·ªÉ sao l∆∞u v√† "Nh·∫≠p JSON" ƒë·ªÉ ph·ª•c h·ªìi/chia s·∫ª.<br>
            - "X√≥a to√†n b·ªô" s·∫Ω x√≥a d·ªØ li·ªáu c·ª•c b·ªô (h·ªá th·ªëng s·∫Ω h·ªèi x√°c nh·∫≠n).
          </div>
        </div>
      </div>

      <footer>Phi√™n b·∫£n local ‚Ä¢ D·ªØ li·ªáu: localStorage ‚Ä¢ T·∫°o b·ªüi tr·ª£ l√Ω</footer>
    </div>
  </div>

  <script>
    // Gi·ªØ d·ªØ li·ªáu trong localStorage key
    const STORAGE_KEY = "giapha_v2";
    // Gi·ªØ danh s√°ch v√†o bi·∫øn
    let members = [];

    // Helper: t·∫°o id an to√†n
    function genId() {
      if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
      return Date.now().toString(36) + Math.random().toString(36).slice(2,9);
    }

    // L·∫•y element
    const el = id => document.getElementById(id);

    // Load / Save
    function loadData() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        members = raw ? JSON.parse(raw) : [];
      } catch (e) {
        console.error("Kh√¥ng th·ªÉ ƒë·ªçc d·ªØ li·ªáu:", e);
        members = [];
      }
    }
    function saveData() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(members));
      flashStatus("ƒê√£ l∆∞u");
    }

    // Flash status nh·ªè
    let statusTimer = null;
    function flashStatus(text="ƒê√£ l∆∞u", ms=1200) {
      const b = el("statusBadge");
      b.style.display = "inline-block";
      b.textContent = text;
      if (statusTimer) clearTimeout(statusTimer);
      statusTimer = setTimeout(()=> b.style.display="none", ms);
    }

    // Validation ƒë∆°n gi·∫£n
    function validateForm(data) {
      const errs = [];
      if (!data.hoTen || !data.hoTen.trim()) errs.push("H·ªç v√† t√™n l√† b·∫Øt bu·ªôc.");
      if (!data.doiThu || isNaN(+data.doiThu) || +data.doiThu < 1) errs.push("ƒê·ªùi th·ª© ph·∫£i l√† s·ªë nguy√™n >= 1.");
      if (data.namSinh && (isNaN(+data.namSinh) || +data.namSinh < 1000 || +data.namSinh > 9999)) errs.push("NƒÉm sinh kh√¥ng h·ª£p l·ªá.");
      if (data.namMat && (isNaN(+data.namMat) || +data.namMat < 1000 || +data.namMat > 9999)) errs.push("NƒÉm m·∫•t kh√¥ng h·ª£p l·ªá.");
      // Kh√¥ng cho t·ª± l√†m cha/m·∫π c·ªßa ch√≠nh m√¨nh
      if (data.id && (data.fatherId === data.id || data.motherId === data.id)) errs.push("Kh√¥ng th·ªÉ ƒë·∫∑t ch√≠nh m√¨nh l√†m cha ho·∫∑c m·∫π.");
      return errs;
    }

    // Ghi form -> object
    function getFormData() {
      return {
        id: el("memberId").value || null,
        hoTen: el("hoTen").value.trim(),
        doiThu: el("doiThu").value ? +el("doiThu").value : null,
        fatherId: el("fatherSelect").value || null,
        motherId: el("motherSelect").value || null,
        namSinh: el("namSinh").value ? +el("namSinh").value : null,
        namMat: el("namMat").value ? +el("namMat").value : null,
        ghiChu: el("ghiChu").value.trim() || ""
      };
    }

    // G√°n form t·ª´ object
    function setFormData(m) {
      el("memberId").value = m.id || "";
      el("hoTen").value = m.hoTen || "";
      el("doiThu").value = m.doiThu || "";
      el("fatherSelect").value = m.fatherId || "";
      el("motherSelect").value = m.motherId || "";
      el("namSinh").value = m.namSinh || "";
      el("namMat").value = m.namMat || "";
      el("ghiChu").value = m.ghiChu || "";
      el("formTitle").textContent = m.id ? "Ch·ªânh s·ª≠a th√†nh vi√™n" : "Th√™m th√†nh vi√™n m·ªõi";
    }

    // Clear form
    function clearForm() {
      setFormData({}); // reset
      el("formError").style.display = "none";
      el("formError").textContent = "";
    }

    // Add or update
    function saveMember() {
      const data = getFormData();
      const errs = validateForm(data);
      if (errs.length) {
        el("formError").style.display = "block";
        el("formError").textContent = errs.join(" ");
        return;
      }
      el("formError").style.display = "none";

      if (data.id) {
        // c·∫≠p nh·∫≠t
        const idx = members.findIndex(m => m.id === data.id);
        if (idx === -1) {
          alert("Kh√¥ng t√¨m th·∫•y th√†nh vi√™n ƒë·ªÉ c·∫≠p nh·∫≠t.");
          return;
        }
        // preserve createdAt
        data.updatedAt = new Date().toISOString();
        data.createdAt = members[idx].createdAt || data.createdAt || new Date().toISOString();
        members[idx] = data;
      } else {
        // th√™m m·ªõi
        data.id = genId();
        data.createdAt = new Date().toISOString();
        data.updatedAt = data.createdAt;
        members.push(data);
      }
      saveData();
      renderAll();
      clearForm();
    }

    // Delete
    function deleteMember(id) {
      if (!confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a th√†nh vi√™n n√†y? H√†nh ƒë·ªông kh√¥ng th·ªÉ ho√†n t√°c.")) return;
      // Khi x√≥a, ta s·∫Ω gi·ªØ c√°c b·∫£n con (children) nh∆∞ng b·ªè li√™n k·∫øt cha/m·∫π n·∫øu tr·ªè t·ªõi id n√†y
      members = members.filter(m => m.id !== id);
      members.forEach(m => {
        if (m.fatherId === id) m.fatherId = null;
        if (m.motherId === id) m.motherId = null;
      });
      saveData();
      renderAll();
    }

    // Edit: load member v√†o form
    function editMember(id) {
      const m = members.find(x => x.id === id);
      if (!m) return;
      setFormData(m);
      // scroll up to form
      window.scrollTo({top:0, behavior:"smooth"});
    }

    // Populate parent selects
    function populateParentSelects() {
      const father = el("fatherSelect"), mother = el("motherSelect");
      const prevFather = father.value;
      const prevMother = mother.value;
      father.innerHTML = '<option value="">‚Äî Ch·ªçn cha (n·∫øu l√† th√†nh vi√™n kh√°c) ‚Äî</option>';
      mother.innerHTML = '<option value="">‚Äî Ch·ªçn m·∫π (n·∫øu l√† th√†nh vi√™n kh√°c) ‚Äî</option>';
      const sorted = [...members].sort((a,b)=> a.hoTen.localeCompare(b.hoTen));
      sorted.forEach(m => {
        const opt1 = document.createElement("option");
        opt1.value = m.id; opt1.textContent = `${m.hoTen}${m.namSinh ? " ("+m.namSinh+")": ""}`;
        father.appendChild(opt1);
        const opt2 = opt1.cloneNode(true);
        mother.appendChild(opt2);
      });
      // restore selection where possible
      if (sorted.some(s=>s.id===prevFather)) father.value = prevFather;
      if (sorted.some(s=>s.id===prevMother)) mother.value = prevMother;
    }

    // Render danh s√°ch theo filter/search/sort
    function renderList() {
      const container = el("danhSach");
      container.innerHTML = "";
      let results = [...members];

      // filter generation
      const genFilter = el("filterGeneration").value;
      if (genFilter) results = results.filter(r => String(r.doiThu) === genFilter);

      // search
      const q = el("searchInput").value.trim().toLowerCase();
      if (q) {
        results = results.filter(m => {
          return (m.hoTen && m.hoTen.toLowerCase().includes(q)) ||
                 (m.ghiChu && m.ghiChu.toLowerCase().includes(q)) ||
                 (m.namSinh && String(m.namSinh).includes(q)) ||
                 (m.namMat && String(m.namMat).includes(q));
        });
      }

      // sort
      const sort = el("sortSelect").value;
      results.sort((a,b)=> {
        if (sort === "name") return a.hoTen.localeCompare(b.hoTen);
        if (sort === "doi-asc") return (+a.doiThu||0) - (+b.doiThu||0);
        if (sort === "doi-desc") return (+b.doiThu||0) - (+a.doiThu||0);
        if (sort === "born-asc") return (+a.namSinh||9999) - (+b.namSinh||9999);
        if (sort === "born-desc") return (+b.namSinh||9999) - (+a.namSinh||9999);
        return 0;
      });

      if (!results.length) {
        container.innerHTML = '<div class="note">Ch∆∞a c√≥ th√†nh vi√™n ph√π h·ª£p.</div>';
        return;
      }

      results.forEach(m => {
        const div = document.createElement("div");
        div.className = "member";
        const left = document.createElement("div");
        const title = document.createElement("div");
        title.innerHTML = `<b>${m.hoTen}</b> <span class="meta"> (ƒê·ªùi ${m.doiThu || "?"})</span>`;
        const meta = document.createElement("div");
        meta.className = "meta";
        let details = "";
        details += m.fatherId ? `Cha: ${getNameById(m.fatherId)} ‚Ä¢ ` : "";
        details += m.motherId ? `M·∫π: ${getNameById(m.motherId)} ‚Ä¢ ` : "";
        if (m.namSinh) details += `Sinh: ${m.namSinh} `;
        if (m.namMat) details += `- M·∫•t: ${m.namMat} `;
        if (m.ghiChu) details += `<div style="margin-top:6px"><i>${m.ghiChu}</i></div>`;
        meta.innerHTML = details;
        left.appendChild(title);
        left.appendChild(meta);

        const right = document.createElement("div");
        right.className = "actions";
        // Edit
        const btnEdit = document.createElement("button");
        btnEdit.className = "ghost";
        btnEdit.textContent = "S·ª≠a";
        btnEdit.onclick = ()=> editMember(m.id);
        // Center in tree
        const btnCenter = document.createElement("button");
        btnCenter.className = "ghost";
        btnCenter.textContent = "T√¥ s√°ng";
        btnCenter.onclick = ()=> renderTree(m.id);
        // Delete
        const btnDel = document.createElement("button");
        btnDel.className = "warn";
        btnDel.textContent = "X√≥a";
        btnDel.onclick = ()=> deleteMember(m.id);

        right.appendChild(btnEdit);
        right.appendChild(btnCenter);
        right.appendChild(btnDel);

        div.appendChild(left);
        div.appendChild(right);
        container.appendChild(div);
      });
    }

    function getNameById(id) {
      const m = members.find(x=>x.id===id);
      return m ? m.hoTen : "(kh√¥ng t·ªìn t·∫°i)";
    }

    // Build tree: nh√≥m theo cha/m·∫π (t·∫°o map children)
    function buildTreeRoots() {
      // Create id->node map
      const map = new Map();
      members.forEach(m => map.set(m.id, {...m, children: []}));
      // For each member, if has fatherId or motherId, attach as child to those parents.
      // We'll prefer father linking for tree root decisions; nodes with no parent become roots.
      map.forEach(node=>{
        if (node.fatherId && map.has(node.fatherId)) {
          map.get(node.fatherId).children.push(node);
        } else if (node.motherId && map.has(node.motherId)) {
          map.get(node.motherId).children.push(node);
        }
      });
      // roots: those not attached as child to any other node
      const attached = new Set();
      map.forEach(node=>{
        node.children.forEach(c => attached.add(c.id));
      });
      const roots = [];
      map.forEach(node=>{
        if (!attached.has(node.id)) roots.push(node);
      });
      // if no roots (cycle or all linked), fallback to all nodes sorted by generation
      if (!roots.length) {
        const arr = [...map.values()].sort((a,b)=> (a.doiThu||0)-(b.doiThu||0));
        return arr;
      }
      // sort roots by doiThu then name
      roots.sort((a,b)=> (a.doiThu||0)-(b.doiThu||0) || a.hoTen.localeCompare(b.hoTen));
      return roots;
    }

    // Render tree: optional focusId to highlight
    function renderTree(focusId=null) {
      const wrap = el("treeWrap");
      wrap.innerHTML = "";
      if (!members.length) {
        wrap.innerHTML = '<div class="note">Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã c√¢y.</div>';
        return;
      }
      const roots = buildTreeRoots();
      // Recursive render
      function makeNodeHTML(node, depth=0) {
        const li = document.createElement("li");
        li.style.marginBottom = "6px";
        const title = document.createElement("div");
        title.innerHTML = `<b>${node.hoTen}</b> <span class="meta"> (ƒê·ªùi ${node.doiThu||"?"}${node.namSinh? ", " + node.namSinh:""})</span>`;
        if (node.id === focusId) title.style.background = "#fff9db";
        title.style.padding = "6px"; title.style.borderRadius = "8px";
        li.appendChild(title);
        if (node.ghiChu) {
          const note = document.createElement("div");
          note.className = "meta";
          note.style.marginTop = "6px";
          note.innerHTML = `<i>${node.ghiChu}</i>`;
          li.appendChild(note);
        }
        if (node.children && node.children.length) {
          const ul = document.createElement("ul");
          node.children.sort((a,b)=> (a.doiThu||0)-(b.doiThu||0) || a.hoTen.localeCompare(b.hoTen));
          node.children.forEach(child => ul.appendChild(makeNodeHTML(child, depth+1)));
          li.appendChild(ul);
        }
        return li;
      }
      // Attach to wrap
      const outer = document.createElement("div");
      roots.forEach(r => {
        const ul = document.createElement("ul");
        ul.appendChild(makeNodeHTML(r));
        outer.appendChild(ul);
      });
      wrap.appendChild(outer);
      // Try to scroll to focused element highlight
      if (focusId) {
        const highlighted = wrap.querySelector("div[style*='background: #fff9db']");
        if (highlighted) highlighted.scrollIntoView({behavior:"smooth", block:"center"});
      }
    }

    // Populate generation filter options
    function populateGenerationFilter() {
      const select = el("filterGeneration");
      const gens = Array.from(new Set(members.map(m => m.doiThu).filter(Boolean))).sort((a,b)=>a-b);
      select.innerHTML = '<option value="">T·∫•t c·∫£ ƒë·ªùi</option>';
      gens.forEach(g => {
        const o = document.createElement("option");
        o.value = g; o.textContent = "ƒê·ªùi " + g;
        select.appendChild(o);
      });
    }

    // Export JSON (download)
    function exportJSON() {
      const dataStr = JSON.stringify({ exportedAt: new Date().toISOString(), members }, null, 2);
      const blob = new Blob([dataStr], {type: "application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `giapha_export_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Import JSON (file)
    function importJSONFile(file) {
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const parsed = JSON.parse(e.target.result);
          let incoming = null;
          if (Array.isArray(parsed)) incoming = parsed;
          else if (parsed.members && Array.isArray(parsed.members)) incoming = parsed.members;
          else {
            // maybe old format saved as object with id-indexed
            throw new Error("ƒê·ªãnh d·∫°ng JSON kh√¥ng h·ª£p l·ªá. C·∫ßn m·∫£ng c√°c th√†nh vi√™n ho·∫∑c {members: [...]}.");
          }
          // Confirm: merge or replace
          if (!confirm("Nh·∫≠p d·ªØ li·ªáu s·∫Ω G·ªòP v√†o d·ªØ li·ªáu hi·ªán t·∫°i. Ch·ªçn H·ªßy ƒë·ªÉ thay th·∫ø to√†n b·ªô. Ti·∫øp t·ª•c?")) {
            // replace
            members = incoming;
          } else {
            // merge: add those with new ids, override if same id? We'll skip duplicates by id
            const existingIds = new Set(members.map(m=>m.id));
            incoming.forEach(m=>{
              if (!m.id) m.id = genId();
              if (!existingIds.has(m.id)) members.push(m);
            });
          }
          saveData();
          renderAll();
          alert("Nh·∫≠p d·ªØ li·ªáu ho√†n t·∫•t.");
        } catch (err) {
          alert("L·ªói khi ƒë·ªçc file: " + err.message);
        }
      };
      reader.readAsText(file);
    }

    // Clear all data
    function clearAll() {
      if (!confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô d·ªØ li·ªáu trong localStorage? H√†nh ƒë·ªông kh√¥ng th·ªÉ ho√†n t√°c.")) return;
      members = [];
      saveData();
      renderAll();
    }

    // Render everything
    function renderAll(focusId=null) {
      populateParentSelects();
      populateGenerationFilter();
      renderList();
      renderTree(focusId);
    }

    // Events
    el("saveBtn").addEventListener("click", ()=> saveMember());
    el("resetBtn").addEventListener("click", ()=> clearForm());
    el("clearAllBtn").addEventListener("click", ()=> clearAll());
    el("exportBtn").addEventListener("click", ()=> exportJSON());
    el("importFile").addEventListener("change", (ev)=> {
      const file = ev.target.files[0];
      importJSONFile(file);
      ev.target.value = "";
    });

    el("searchInput").addEventListener("input", ()=> renderList());
    el("filterGeneration").addEventListener("change", ()=> renderList());
    el("sortSelect").addEventListener("change", ()=> renderList());

    // Keyboard: Enter to save when focus in form (except textarea)
    Array.from(document.querySelectorAll("input")).forEach(inp => {
      inp.addEventListener("keydown", (e)=> {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          saveMember();
        }
      });
    });

    // Init
    loadData();
    renderAll();

    // Public helpers to be used in inline events (if any)
    window.editMember = editMember;
    window.deleteMember = deleteMember;
    window.renderTree = renderTree;
    window.getNameById = getNameById;
  </script>
</body>
